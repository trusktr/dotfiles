"use strict";var Qe=Object.create;var he=Object.defineProperty;var Ye=Object.getOwnPropertyDescriptor;var Ze=Object.getOwnPropertyNames;var et=Object.getPrototypeOf,tt=Object.prototype.hasOwnProperty;var D=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports);var rt=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Ze(e))!tt.call(n,i)&&i!==t&&he(n,i,{get:()=>e[i],enumerable:!(r=Ye(e,i))||r.enumerable});return n};var nt=(n,e,t)=>(t=n!=null?Qe(et(n)):{},rt(e||!n||!n.__esModule?he(t,"default",{value:n,enumerable:!0}):t,n));var be=D(k=>{"use strict";Object.defineProperty(k,"__esModule",{value:!0});k.bytePairEncode=k.BinaryMap=k.binaryMapKey=void 0;var it=(n,e,t)=>{let r=t-e,i=16777215>>>Math.max(0,(3-r)*8),s=(n[e+0]|n[e+1]<<8|n[e+2]<<16)&i,o=16777215>>>Math.min(31,Math.max(0,(6-r)*8)),l=(n[e+3]|n[e+4]<<8|n[e+5]<<16)&o;return s+16777216*l};k.binaryMapKey=it;var Y=class n{constructor(){this.nested=new Map,this.final=new Map}get(e,t=0,r=e.length){let i=r<6+t,s=(0,k.binaryMapKey)(e,t,r);return i?this.final.get(s):this.nested.get(s)?.get(e,6+t,r)}set(e,t){let r=(0,k.binaryMapKey)(e,0,e.length);if(e.length<6){this.final.set(r,t);return}let s=this.nested.get(r);if(s instanceof n)s.set(e.subarray(6),t);else{let o=new n;o.set(e.subarray(6),t),this.nested.set(r,o)}}};k.BinaryMap=Y;var w=new Int32Array(128),x=new Int32Array(128);function st(n,e,t){if(t===1)return[e.get(n)];let r=2147483647,i=-1;for(;w.length<t*2;)x=new Int32Array(x.length*2),w=new Int32Array(w.length*2);for(let a=0;a<t-1;a++){let d=e.get(n,a,a+2)??2147483647;d<r&&(r=d,i=a),x[a]=a,w[a]=d}x[t-1]=t-1,w[t-1]=2147483647,x[t]=t,w[t]=2147483647;let s=t+1;function o(a,d=0){if(a+d+2<s){let f=e.get(n,x[a],x[a+d+2]);if(f!==void 0)return f}return 2147483647}for(;r!==2147483647;){w[x[i]]=o(i,1),i>0&&(w[x[i-1]]=o(i-1,1));for(let a=i+1;a<s-1;a++)x[a]=x[a+1];s--,i=-1,r=2147483647;for(let a=0;a<s-1;a++){let d=w[x[a]];w[x[a]]<r&&(r=d,i=a)}}let l=[];for(let a=0;a<s-1;a++)l.push(e.get(n,x[a],x[a+1]));return l}k.bytePairEncode=st});var Te=D(P=>{"use strict";Object.defineProperty(P,"__esModule",{value:!0});P.makeTextEncoder=void 0;var Z=class{constructor(){this.length=0,this.encoder=new TextEncoder}encode(e){let t=this.encoder.encode(e);return this.length=t.length,t}},ee=class{constructor(){this.buffer=Buffer.alloc(256),this.length=0}encode(e){for(;;){if(this.length=this.buffer.write(e,"utf8"),this.length<this.buffer.length-4)return this.buffer;this.buffer=Buffer.alloc(this.length*2),this.length=this.buffer.write(e)}}},ot=()=>typeof Buffer<"u"?new ee:new Z;P.makeTextEncoder=ot});var me=D(N=>{"use strict";Object.defineProperty(N,"__esModule",{value:!0});N.LRUCache=void 0;var te=class{constructor(e){this.size=e,this.nodes=new Map}get(e){let t=this.nodes.get(e);if(t)return this.moveToHead(t),t.value}set(e,t){let r=this.nodes.get(e);if(r)r.value=t,this.moveToHead(r);else{let i=new re(e,t);this.nodes.set(e,i),this.addNode(i),this.nodes.size>this.size&&(this.nodes.delete(this.tail.key),this.removeNode(this.tail))}}moveToHead(e){this.removeNode(e),e.next=void 0,e.prev=void 0,this.addNode(e)}addNode(e){this.head&&(this.head.prev=e,e.next=this.head),this.tail||(this.tail=e),this.head=e}removeNode(e){e.prev?e.prev.next=e.next:this.head=e.next,e.next?e.next.prev=e.prev:this.tail=e.prev}};N.LRUCache=te;var re=class{constructor(e,t){this.key=e,this.value=t}}});var ie=D(U=>{"use strict";Object.defineProperty(U,"__esModule",{value:!0});U.TikTokenizer=void 0;var O=be(),at=Te(),lt=me();function ut(n){let e=new Map;try{let i=require("fs").readFileSync(n,"utf-8");return t(i),e}catch(r){throw new Error(`Failed to load from BPE encoder file stream: ${r}`)}function t(r){for(let i of r.split(/[\r\n]+/)){if(i.trim()==="")continue;let s=i.split(" ");if(s.length!==2)throw new Error("Invalid format in the BPE encoder file stream");let o=new Uint8Array(Buffer.from(s[0],"base64")),l=parseInt(s[1]);if(!isNaN(l))e.set(o,l);else throw new Error(`Can't parse ${s[1]} to integer`)}}}function dt(n){return n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var ne=class{constructor(e,t,r,i=8192){this.textEncoder=(0,at.makeTextEncoder)(),this.textDecoder=new TextDecoder("utf-8"),this.cache=new lt.LRUCache(i);let s=typeof e=="string"?ut(e):e;this.init(s,t,r)}init(e,t,r){this.encoder=new O.BinaryMap;for(let[i,s]of e)this.encoder.set(i,s);this.regex=new RegExp(r,"gu"),this.specialTokensRegex=new RegExp(Array.from(t.keys()).map(i=>dt(i)).join("|")),this.specialTokensEncoder=t,this.decoder=new Map;for(let[i,s]of e)this.decoder.set(s,i);if(e.size!==this.decoder.size)throw new Error("Encoder and decoder sizes do not match");this.specialTokensDecoder=new Map;for(let[i,s]of t)this.specialTokensDecoder.set(s,i)}findNextSpecialToken(e,t,r){let i=t,s=null;if(r&&this.specialTokensRegex)for(;s=e.slice(i).match(this.specialTokensRegex),!(!s||r&&r.includes(s[0]));)i+=s.index+1;let o=s?i+s.index:e.length;return[s,o]}encode(e,t){let r=[],i=0;for(;;){let s,o;if([s,o]=this.findNextSpecialToken(e,i,t),o>i&&this.encodeByIndex(e,r,i,o),s){if(i=i+this.encodeSpecialToken(r,s),i>=e.length)break}else break}return r}encodeSpecialToken(e,t){let r=this.specialTokensEncoder?.get(t[0]);return e.push(r),t.index+t[0].length}encodeByIndex(e,t,r,i){let s,o=e.substring(r,i);for(this.regex.lastIndex=0;s=this.regex.exec(o);){let l=this.cache.get(s[0]);if(l)for(let a of l)t.push(a);else{let a=this.textEncoder.encode(s[0]),d=this.encoder.get(a,0,this.textEncoder.length);if(d!==void 0)t.push(d),this.cache.set(s[0],[d]);else{let f=(0,O.bytePairEncode)(a,this.encoder,this.textEncoder.length);for(let c of f)t.push(c);this.cache.set(s[0],f)}}}}encodeTrimSuffixByIndex(e,t,r,i,s,o,l){let a,d=e.substring(r,i);for(this.regex.lastIndex=0;a=this.regex.exec(d);){let f=a[0],c=this.cache.get(f);if(c)if(o+c.length<=s)o+=c.length,l+=f.length,t.push(...c);else{let b=s-o;o+=b,l+=f.length,t.push(...c.slice(0,b));break}else{let b=this.textEncoder.encode(f),y=this.encoder.get(b,0,b.length);if(y!==void 0)if(this.cache.set(f,[y]),o+1<=s)o++,l+=f.length,t.push(y);else break;else{let _=(0,O.bytePairEncode)(b,this.encoder,this.textEncoder.length);if(this.cache.set(f,_),o+_.length<=s){o+=_.length,l+=f.length;for(let I of _)t.push(I)}else{let I=s-o;o+=I,l+=f.length;for(let g=0;g<I;g++)t.push(_[g]);break}}}if(o>=s)break}return{tokenCount:o,encodeLength:l}}encodeTrimSuffix(e,t,r){let i=[],s=0,o=0,l=0;for(;;){let d,f;if([d,f]=this.findNextSpecialToken(e,s,r),f>s){let{tokenCount:c,encodeLength:b}=this.encodeTrimSuffixByIndex(e,i,s,f,t,o,l);if(o=c,l=b,o>=t)break}if(d!==null){if(o++,o<=t&&(s=s+this.encodeSpecialToken(i,d),l+=d[0].length,s>=e.length)||o>=t)break}else break}let a=l===e.length?e:e.slice(0,l);return{tokenIds:i,text:a}}encodeTrimPrefix(e,t,r){let i=[],s=0,o=0,l=0,a=new Map;for(a.set(o,l);;){let b,y;if([b,y]=this.findNextSpecialToken(e,s,r),y>s){let _,I=e.substring(s,y);for(this.regex.lastIndex=0;_=this.regex.exec(I);){let g=_[0],R=this.cache.get(g);if(R)o+=R.length,l+=g.length,i.push(...R),a.set(o,l);else{let Q=this.textEncoder.encode(g),L=this.encoder.get(Q);if(L!==void 0)this.cache.set(g,[L]),o++,l+=g.length,i.push(L),a.set(o,l);else{let A=(0,O.bytePairEncode)(Q,this.encoder,this.textEncoder.length);this.cache.set(g,A),o+=A.length,l+=g.length;for(let u of A)i.push(u);a.set(o,l)}}}}if(b!==null){if(s=s+this.encodeSpecialToken(i,b),o++,l+=b[0].length,a.set(o,l),s>=e.length)break}else break}if(o<=t)return{tokenIds:i,text:e};let d=o-t,f=0,c=0;for(let[b,y]of a)if(b>=d){f=b,c=y;break}if(f>t){let b=this.encode(e,r),y=b.slice(b.length-t);return{tokenIds:y,text:this.decode(y)}}return{tokenIds:i.slice(f),text:e.slice(c)}}decode(e){let t=[];for(let r of e){let i=[],s=this.decoder?.get(r);if(s!==void 0)i=Array.from(s);else{let o=this.specialTokensDecoder?.get(r);if(o!==void 0){let l=this.textEncoder.encode(o);i=Array.from(l.subarray(0,this.textEncoder.length))}}t.push(...i)}return this.textDecoder.decode(new Uint8Array(t))}};U.TikTokenizer=ne});var Se=D(T=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0});T.createTokenizer=T.createByEncoderName=T.createByModelName=T.getRegexByModel=T.getRegexByEncoder=T.getSpecialTokensByModel=T.getSpecialTokensByEncoder=T.MODEL_TO_ENCODING=void 0;var ct=ie(),ft=new Map([["gpt-4o-","o200k_base"],["gpt-4-","cl100k_base"],["gpt-3.5-turbo-","cl100k_base"],["gpt-35-turbo-","cl100k_base"]]);T.MODEL_TO_ENCODING=new Map([["gpt-4o","o200k_base"],["gpt-4","cl100k_base"],["gpt-3.5-turbo","cl100k_base"],["text-davinci-003","p50k_base"],["text-davinci-002","p50k_base"],["text-davinci-001","r50k_base"],["text-curie-001","r50k_base"],["text-babbage-001","r50k_base"],["text-ada-001","r50k_base"],["davinci","r50k_base"],["curie","r50k_base"],["babbage","r50k_base"],["ada","r50k_base"],["code-davinci-002","p50k_base"],["code-davinci-001","p50k_base"],["code-cushman-002","p50k_base"],["code-cushman-001","p50k_base"],["davinci-codex","p50k_base"],["cushman-codex","p50k_base"],["text-davinci-edit-001","p50k_edit"],["code-davinci-edit-001","p50k_edit"],["text-embedding-ada-002","cl100k_base"],["text-similarity-davinci-001","r50k_base"],["text-similarity-curie-001","r50k_base"],["text-similarity-babbage-001","r50k_base"],["text-similarity-ada-001","r50k_base"],["text-search-davinci-doc-001","r50k_base"],["text-search-curie-doc-001","r50k_base"],["text-search-babbage-doc-001","r50k_base"],["text-search-ada-doc-001","r50k_base"],["code-search-babbage-code-001","r50k_base"],["code-search-ada-code-001","r50k_base"],["gpt2","gpt2"]]);var F="<|endoftext|>",ye="<|fim_prefix|>",ge="<|fim_middle|>",xe="<|fim_suffix|>",ve="<|endofprompt|>",V="'s|'t|'re|'ve|'m|'ll|'d| ?\\p{L}+| ?\\p{N}+| ?[^\\s\\p{L}\\p{N}]+|\\s+(?!\\S)|\\s+",_e="(?:'s|'S|'t|'T|'re|'RE|'Re|'eR|'ve|'VE|'vE|'Ve|'m|'M|'ll|'lL|'Ll|'LL|'d|'D)|[^\\r\\n\\p{L}\\p{N}]?\\p{L}+|\\p{N}{1,3}| ?[^\\s\\p{L}\\p{N}]+[\\r\\n]*|\\s*[\\r\\n]+|\\s+(?!\\S)|\\s+",pt=[`[^\r
\\p{L}\\p{N}]?[\\p{Lu}\\p{Lt}\\p{Lm}\\p{Lo}\\p{M}]*[\\p{Ll}\\p{Lm}\\p{Lo}\\p{M}]+(?:'s|'S|'t|'T|'re|'RE|'Re|'eR|'ve|'VE|'vE|'Ve|'m|'M|'ll|'lL|'Ll|'LL|'d|'D)?`,`[^\r
\\p{L}\\p{N}]?[\\p{Lu}\\p{Lt}\\p{Lm}\\p{Lo}\\p{M}]+[\\p{Ll}\\p{Lm}\\p{Lo}\\p{M}]*(?:'s|'S|'t|'T|'re|'RE|'Re|'eR|'ve|'VE|'vE|'Ve|'m|'M|'ll|'lL|'Ll|'LL|'d|'D)?`,"\\p{N}{1,3}"," ?[^\\s\\p{L}\\p{N}]+[\\r\\n/]*","\\s*[\\r\\n]+","\\s+(?!\\S)","\\s+"],Ie=pt.join("|");function se(n){let e="";if(T.MODEL_TO_ENCODING.has(n))e=T.MODEL_TO_ENCODING.get(n);else for(let[t,r]of ft)if(n.startsWith(t)){e=r;break}return e}async function ht(n,e){let t=require("fs"),r=await fetch(n);if(!r.ok)throw new Error(`Failed to fetch file from ${n}. Status code: ${r.status}`);let i=await r.text();t.writeFileSync(e,i)}function oe(n){let e=new Map([[F,50256]]);switch(n){case"o200k_base":e=new Map([[F,199999],[ve,200018]]);break;case"cl100k_base":e=new Map([[F,100257],[ye,100258],[ge,100259],[xe,100260],[ve,100276]]);break;case"p50k_edit":e=new Map([[F,50256],[ye,50281],[ge,50282],[xe,50283]]);break;default:break}return e}T.getSpecialTokensByEncoder=oe;function bt(n){let e=se(n);return oe(e)}T.getSpecialTokensByModel=bt;function we(n){switch(n){case"o200k_base":return Ie;case"cl100k_base":return _e;default:break}return V}T.getRegexByEncoder=we;function Tt(n){let e=se(n);return we(e)}T.getRegexByModel=Tt;async function mt(n,e=null){return ke(se(n),e)}T.createByModelName=mt;async function ke(n,e=null){let t,r,i=oe(n);switch(n){case"o200k_base":t=Ie,r="https://openaipublic.blob.core.windows.net/encodings/o200k_base.tiktoken";break;case"cl100k_base":t=_e,r="https://openaipublic.blob.core.windows.net/encodings/cl100k_base.tiktoken";break;case"p50k_base":t=V,r="https://openaipublic.blob.core.windows.net/encodings/p50k_base.tiktoken";break;case"p50k_edit":t=V,r="https://openaipublic.blob.core.windows.net/encodings/p50k_base.tiktoken";break;case"r50k_base":t=V,r="https://openaipublic.blob.core.windows.net/encodings/r50k_base.tiktoken";break;case"gpt2":t=V,r="https://raw.githubusercontent.com/microsoft/Tokenizer/main/model/gpt2.tiktoken";break;default:throw new Error(`Doesn't support this encoder [${n}]`)}e!==null&&(i=new Map([...i,...e]));let s=require("fs"),o=require("path"),l=o.basename(r),a=o.resolve(__dirname,"..","model");s.existsSync(a)||s.mkdirSync(a,{recursive:!0});let d=o.resolve(a,l);return s.existsSync(d)||(console.log(`Downloading file from ${r}`),await ht(r,d),console.log(`Saved file to ${d}`)),Ee(d,i,t)}T.createByEncoderName=ke;function Ee(n,e,t,r=8192){return new ct.TikTokenizer(n,e,t,r)}T.createTokenizer=Ee});var Re=D(m=>{"use strict";Object.defineProperty(m,"__esModule",{value:!0});m.createTokenizer=m.createByEncoderName=m.createByModelName=m.getSpecialTokensByModel=m.getSpecialTokensByEncoder=m.getRegexByModel=m.getRegexByEncoder=m.MODEL_TO_ENCODING=m.TikTokenizer=void 0;var yt=ie();Object.defineProperty(m,"TikTokenizer",{enumerable:!0,get:function(){return yt.TikTokenizer}});var E=Se();Object.defineProperty(m,"MODEL_TO_ENCODING",{enumerable:!0,get:function(){return E.MODEL_TO_ENCODING}});Object.defineProperty(m,"getRegexByEncoder",{enumerable:!0,get:function(){return E.getRegexByEncoder}});Object.defineProperty(m,"getRegexByModel",{enumerable:!0,get:function(){return E.getRegexByModel}});Object.defineProperty(m,"getSpecialTokensByEncoder",{enumerable:!0,get:function(){return E.getSpecialTokensByEncoder}});Object.defineProperty(m,"getSpecialTokensByModel",{enumerable:!0,get:function(){return E.getSpecialTokensByModel}});Object.defineProperty(m,"createByModelName",{enumerable:!0,get:function(){return E.createByModelName}});Object.defineProperty(m,"createByEncoderName",{enumerable:!0,get:function(){return E.createByEncoderName}});Object.defineProperty(m,"createTokenizer",{enumerable:!0,get:function(){return E.createTokenizer}})});var Je=require("worker_threads");var M=nt(Re());var ae=class{constructor(){this.listeners=[],this.unexpectedErrorHandler=function(e){setTimeout(()=>{throw e.stack?j.isErrorNoTelemetry(e)?new j(e.message+`

`+e.stack):new Error(e.message+`

`+e.stack):e},0)}}addListener(e){return this.listeners.push(e),()=>{this._removeListener(e)}}emit(e){this.listeners.forEach(t=>{t(e)})}_removeListener(e){this.listeners.splice(this.listeners.indexOf(e),1)}setUnexpectedErrorHandler(e){this.unexpectedErrorHandler=e}getUnexpectedErrorHandler(){return this.unexpectedErrorHandler}onUnexpectedError(e){this.unexpectedErrorHandler(e),this.emit(e)}onUnexpectedExternalError(e){this.unexpectedErrorHandler(e)}},$t=new ae;var j=class n extends Error{constructor(e){super(e),this.name="CodeExpectedError"}static fromError(e){if(e instanceof n)return e;let t=new n;return t.message=e.message,t.stack=e.stack,t}static isErrorNoTelemetry(e){return e.name==="CodeExpectedError"}};var S=class{constructor(){this._n=1;this._val=0}update(e){return this._val=this._val+(e-this._val)/this._n,this._n+=1,this._val}get value(){return this._val}};var vt=globalThis.performance&&typeof globalThis.performance.now=="function",C=class n{static create(e){return new n(e)}constructor(e){this._now=vt&&e===!1?Date.now:globalThis.performance.now.bind(globalThis.performance),this._startTime=this._now(),this._stopTime=-1}stop(){this._stopTime=this._now()}reset(){this._startTime=this._now(),this._stopTime=-1}elapsed(){return this._stopTime!==-1?this._stopTime-this._startTime:this._now()-this._startTime}};var He=require("fs");var z=class{constructor(e){this.executor=e;this._didRun=!1}get hasValue(){return this._didRun}get value(){if(!this._didRun)try{this._value=this.executor()}catch(e){this._error=e}finally{this._didRun=!0}if(this._error)throw this._error;return this._value}get rawValue(){return this._value}};function _t(n,e,t=0,r=n.length){let i=t,s=r;for(;i<s;){let o=Math.floor((i+s)/2);e(n[o])?i=o+1:s=o}return i-1}var De=class n{constructor(e){this._array=e;this._findLastMonotonousLastIdx=0}static{this.assertInvariants=!1}findLastMonotonous(e){if(n.assertInvariants){if(this._prevFindLastPredicate){for(let r of this._array)if(this._prevFindLastPredicate(r)&&!e(r))throw new Error("MonotonousArray: current predicate must be weaker than (or equal to) the previous predicate.")}this._prevFindLastPredicate=e}let t=_t(this._array,e,this._findLastMonotonousLastIdx);return this._findLastMonotonousLastIdx=t+1,t===-1?void 0:this._array[t]}};var Ae;(l=>{function n(a){return a<0}l.isLessThan=n;function e(a){return a<=0}l.isLessThanOrEqual=e;function t(a){return a>0}l.isGreaterThan=t;function r(a){return a===0}l.isNeitherLessOrGreaterThan=r,l.greaterThan=1,l.lessThan=-1,l.neitherLessOrGreaterThan=0})(Ae||={});function Ve(n,e){return(t,r)=>e(n(t),n(r))}var Be=(n,e)=>n-e;var Me=class n{constructor(e){this.iterate=e}static{this.empty=new n(e=>{})}forEach(e){this.iterate(t=>(e(t),!0))}toArray(){let e=[];return this.iterate(t=>(e.push(t),!0)),e}filter(e){return new n(t=>this.iterate(r=>e(r)?t(r):!0))}map(e){return new n(t=>this.iterate(r=>t(e(r))))}some(e){let t=!1;return this.iterate(r=>(t=e(r),!t)),t}findFirst(e){let t;return this.iterate(r=>e(r)?(t=r,!1):!0),t}findLast(e){let t;return this.iterate(r=>(e(r)&&(t=r),!0)),t}findLastMaxBy(e){let t,r=!0;return this.iterate(i=>((r||Ae.isGreaterThan(e(i,t)))&&(r=!1,t=i),!0)),t}};function Ne(n,e){let t=Object.create(null);for(let r of n){let i=e(r),s=t[i];s||(s=t[i]=[]),s.push(r)}return t}var Ke,Pe,Le=class{constructor(e,t){this.toKey=t;this._map=new Map;this[Ke]="SetWithKey";for(let r of e)this.add(r)}get size(){return this._map.size}add(e){let t=this.toKey(e);return this._map.set(t,e),this}delete(e){return this._map.delete(this.toKey(e))}has(e){return this._map.has(this.toKey(e))}*entries(){for(let e of this._map.values())yield[e,e]}keys(){return this.values()}*values(){for(let e of this._map.values())yield e}clear(){this._map.clear()}forEach(e,t){this._map.forEach(r=>e.call(t,r,r,this))}[(Pe=Symbol.iterator,Ke=Symbol.toStringTag,Pe)](){return this.values()}};var le=class{constructor(e,t){this.uri=e;this.value=t}};function It(n){return Array.isArray(n)}var Fe,$=class n{constructor(e,t){this[Fe]="ResourceMap";if(e instanceof n)this.map=new Map(e.map),this.toKey=t??n.defaultToKey;else if(It(e)){this.map=new Map,this.toKey=t??n.defaultToKey;for(let[r,i]of e)this.set(r,i)}else this.map=new Map,this.toKey=e??n.defaultToKey}static{this.defaultToKey=e=>e.toString()}set(e,t){return this.map.set(this.toKey(e),new le(e,t)),this}get(e){return this.map.get(this.toKey(e))?.value}has(e){return this.map.has(this.toKey(e))}get size(){return this.map.size}clear(){this.map.clear()}delete(e){return this.map.delete(this.toKey(e))}forEach(e,t){typeof t<"u"&&(e=e.bind(t));for(let[r,i]of this.map)e(i.value,i.uri,this)}*values(){for(let e of this.map.values())yield e.value}*keys(){for(let e of this.map.values())yield e.uri}*entries(){for(let e of this.map.values())yield[e.uri,e.value]}*[(Fe=Symbol.toStringTag,Symbol.iterator)](){for(let[,e]of this.map)yield[e.uri,e.value]}},je,Oe=class{constructor(e,t){this[je]="ResourceSet";!e||typeof e=="function"?this._map=new $(e):(this._map=new $(t),e.forEach(this.add,this))}get size(){return this._map.size}add(e){return this._map.set(e,e),this}clear(){this._map.clear()}delete(e){return this._map.delete(e)}forEach(e,t){this._map.forEach((r,i)=>e.call(t,i,i,this))}has(e){return this._map.has(e)}entries(){return this._map.entries()}keys(){return this._map.keys()}values(){return this._map.keys()}[(je=Symbol.toStringTag,Symbol.iterator)](){return this.keys()}};var Ce,Ue=class{constructor(){this[Ce]="LinkedMap";this._map=new Map,this._head=void 0,this._tail=void 0,this._size=0,this._state=0}clear(){this._map.clear(),this._head=void 0,this._tail=void 0,this._size=0,this._state++}isEmpty(){return!this._head&&!this._tail}get size(){return this._size}get first(){return this._head?.value}get last(){return this._tail?.value}has(e){return this._map.has(e)}get(e,t=0){let r=this._map.get(e);if(r)return t!==0&&this.touch(r,t),r.value}set(e,t,r=0){let i=this._map.get(e);if(i)i.value=t,r!==0&&this.touch(i,r);else{switch(i={key:e,value:t,next:void 0,previous:void 0},r){case 0:this.addItemLast(i);break;case 1:this.addItemFirst(i);break;case 2:this.addItemLast(i);break;default:this.addItemLast(i);break}this._map.set(e,i),this._size++}return this}delete(e){return!!this.remove(e)}remove(e){let t=this._map.get(e);if(t)return this._map.delete(e),this.removeItem(t),this._size--,t.value}shift(){if(!this._head&&!this._tail)return;if(!this._head||!this._tail)throw new Error("Invalid list");let e=this._head;return this._map.delete(e.key),this.removeItem(e),this._size--,e.value}forEach(e,t){let r=this._state,i=this._head;for(;i;){if(t?e.bind(t)(i.value,i.key,this):e(i.value,i.key,this),this._state!==r)throw new Error("LinkedMap got modified during iteration.");i=i.next}}keys(){let e=this,t=this._state,r=this._head,i={[Symbol.iterator](){return i},next(){if(e._state!==t)throw new Error("LinkedMap got modified during iteration.");if(r){let s={value:r.key,done:!1};return r=r.next,s}else return{value:void 0,done:!0}}};return i}values(){let e=this,t=this._state,r=this._head,i={[Symbol.iterator](){return i},next(){if(e._state!==t)throw new Error("LinkedMap got modified during iteration.");if(r){let s={value:r.value,done:!1};return r=r.next,s}else return{value:void 0,done:!0}}};return i}entries(){let e=this,t=this._state,r=this._head,i={[Symbol.iterator](){return i},next(){if(e._state!==t)throw new Error("LinkedMap got modified during iteration.");if(r){let s={value:[r.key,r.value],done:!1};return r=r.next,s}else return{value:void 0,done:!0}}};return i}[(Ce=Symbol.toStringTag,Symbol.iterator)](){return this.entries()}trimOld(e){if(e>=this.size)return;if(e===0){this.clear();return}let t=this._head,r=this.size;for(;t&&r>e;)this._map.delete(t.key),t=t.next,r--;this._head=t,this._size=r,t&&(t.previous=void 0),this._state++}trimNew(e){if(e>=this.size)return;if(e===0){this.clear();return}let t=this._tail,r=this.size;for(;t&&r>e;)this._map.delete(t.key),t=t.previous,r--;this._tail=t,this._size=r,t&&(t.next=void 0),this._state++}addItemFirst(e){if(!this._head&&!this._tail)this._tail=e;else if(this._head)e.next=this._head,this._head.previous=e;else throw new Error("Invalid list");this._head=e,this._state++}addItemLast(e){if(!this._head&&!this._tail)this._head=e;else if(this._tail)e.previous=this._tail,this._tail.next=e;else throw new Error("Invalid list");this._tail=e,this._state++}removeItem(e){if(e===this._head&&e===this._tail)this._head=void 0,this._tail=void 0;else if(e===this._head){if(!e.next)throw new Error("Invalid list");e.next.previous=void 0,this._head=e.next}else if(e===this._tail){if(!e.previous)throw new Error("Invalid list");e.previous.next=void 0,this._tail=e.previous}else{let t=e.next,r=e.previous;if(!t||!r)throw new Error("Invalid list");t.previous=r,r.next=t}e.next=void 0,e.previous=void 0,this._state++}touch(e,t){if(!this._head||!this._tail)throw new Error("Invalid list");if(!(t!==1&&t!==2)){if(t===1){if(e===this._head)return;let r=e.next,i=e.previous;e===this._tail?(i.next=void 0,this._tail=i):(r.previous=i,i.next=r),e.previous=void 0,e.next=this._head,this._head.previous=e,this._head=e,this._state++}else if(t===2){if(e===this._tail)return;let r=e.next,i=e.previous;e===this._head?(r.previous=void 0,this._head=r):(r.previous=i,i.next=r),e.next=void 0,e.previous=this._tail,this._tail.next=e,this._tail=e,this._state++}}}toJSON(){let e=[];return this.forEach((t,r)=>{e.push([r,t])}),e}fromJSON(e){this.clear();for(let[t,r]of e)this.set(t,r)}};var W=class{constructor(){this.map=new Map}add(e,t){let r=this.map.get(e);r||(r=new Set,this.map.set(e,r)),r.add(t)}delete(e,t){let r=this.map.get(e);r&&(r.delete(t),r.size===0&&this.map.delete(e))}forEach(e,t){let r=this.map.get(e);r&&r.forEach(t)}get(e){let t=this.map.get(e);return t||new Set}};function ze(n){return!!n&&typeof n[Symbol.iterator]=="function"}var ue;(A=>{function n(u){return u&&typeof u=="object"&&typeof u[Symbol.iterator]=="function"}A.is=n;let e=Object.freeze([]);function t(){return e}A.empty=t;function*r(u){yield u}A.single=r;function i(u){return n(u)?u:r(u)}A.wrap=i;function s(u){return u||e}A.from=s;function*o(u){for(let p=u.length-1;p>=0;p--)yield u[p]}A.reverse=o;function l(u){return!u||u[Symbol.iterator]().next().done===!0}A.isEmpty=l;function a(u){return u[Symbol.iterator]().next().value}A.first=a;function d(u,p){let h=0;for(let v of u)if(p(v,h++))return!0;return!1}A.some=d;function f(u,p){for(let h of u)if(p(h))return h}A.find=f;function*c(u,p){for(let h of u)p(h)&&(yield h)}A.filter=c;function*b(u,p){let h=0;for(let v of u)yield p(v,h++)}A.map=b;function*y(u,p){let h=0;for(let v of u)yield*p(v,h++)}A.flatMap=y;function*_(...u){for(let p of u)ze(p)?yield*p:yield p}A.concat=_;function I(u,p,h){let v=h;for(let K of u)v=p(v,K);return v}A.reduce=I;function g(u){let p=0;for(let h of u)p++;return p}A.length=g;function*R(u,p,h=u.length){for(p<-u.length&&(p=0),p<0&&(p+=u.length),h<0?h+=u.length:h>u.length&&(h=u.length);p<h;p++)yield u[p]}A.slice=R;function Q(u,p=Number.POSITIVE_INFINITY){let h=[];if(p===0)return[h,u];let v=u[Symbol.iterator]();for(let K=0;K<p;K++){let pe=v.next();if(pe.done)return[h,A.empty()];h.push(pe.value)}return[h,{[Symbol.iterator](){return v}}]}A.consume=Q;async function L(u){let p=[];for await(let h of u)p.push(h);return Promise.resolve(p)}A.asyncToArray=L})(ue||={});var wt=!1,H=null;var $e=class n{constructor(){this.livingDisposables=new Map}static{this.idx=0}getDisposableData(e){let t=this.livingDisposables.get(e);return t||(t={parent:null,source:null,isSingleton:!1,value:e,idx:n.idx++},this.livingDisposables.set(e,t)),t}trackDisposable(e){let t=this.getDisposableData(e);t.source||(t.source=new Error().stack)}setParent(e,t){let r=this.getDisposableData(e);r.parent=t}markAsDisposed(e){this.livingDisposables.delete(e)}markAsSingleton(e){this.getDisposableData(e).isSingleton=!0}getRootParent(e,t){let r=t.get(e);if(r)return r;let i=e.parent?this.getRootParent(this.getDisposableData(e.parent),t):e;return t.set(e,i),i}getTrackedDisposables(){let e=new Map;return[...this.livingDisposables.entries()].filter(([,r])=>r.source!==null&&!this.getRootParent(r,e).isSingleton).flatMap(([r])=>r)}computeLeakingDisposables(e=10,t){let r;if(t)r=t;else{let a=new Map,d=[...this.livingDisposables.values()].filter(c=>c.source!==null&&!this.getRootParent(c,a).isSingleton);if(d.length===0)return;let f=new Set(d.map(c=>c.value));if(r=d.filter(c=>!(c.parent&&f.has(c.parent))),r.length===0)throw new Error("There are cyclic diposable chains!")}if(!r)return;function i(a){function d(c,b){for(;c.length>0&&b.some(y=>typeof y=="string"?y===c[0]:c[0].match(y));)c.shift()}let f=a.source.split(`
`).map(c=>c.trim().replace("at ","")).filter(c=>c!=="");return d(f,["Error",/^trackDisposable \(.*\)$/,/^DisposableTracker.trackDisposable \(.*\)$/]),f.reverse()}let s=new W;for(let a of r){let d=i(a);for(let f=0;f<=d.length;f++)s.add(d.slice(0,f).join(`
`),a)}r.sort(Ve(a=>a.idx,Be));let o="",l=0;for(let a of r.slice(0,e)){l++;let d=i(a),f=[];for(let c=0;c<d.length;c++){let b=d[c];b=`(shared with ${s.get(d.slice(0,c+1).join(`
`)).size}/${r.length} leaks) at ${b}`;let _=s.get(d.slice(0,c).join(`
`)),I=Ne([..._].map(g=>i(g)[c]),g=>g);delete I[d[c]];for(let[g,R]of Object.entries(I))f.unshift(`    - stacktraces of ${R.length} other leaks continue with ${g}`);f.unshift(b)}o+=`


==================== Leaking disposable ${l}/${r.length}: ${a.value.constructor.name} ====================
${f.join(`
`)}
============================================================

`}return r.length>e&&(o+=`


... and ${r.length-e} more leaking disposables

`),{leaks:r,details:o}}};function kt(n){H=n}if(wt){let n="__is_disposable_tracked__";kt(new class{trackDisposable(e){let t=new Error("Potentially leaked disposable").stack;setTimeout(()=>{e[n]||console.log(t)},3e3)}setParent(e,t){if(e&&e!==G.None)try{e[n]=!0}catch{}}markAsDisposed(e){if(e&&e!==G.None)try{e[n]=!0}catch{}}markAsSingleton(e){}})}function We(n){return H?.trackDisposable(n),n}function qe(n){H?.markAsDisposed(n)}function de(n,e){H?.setParent(n,e)}function Et(n){if(ue.is(n)){let e=[];for(let t of n)if(t)try{t.dispose()}catch(r){e.push(r)}if(e.length===1)throw e[0];if(e.length>1)throw new AggregateError(e,"Encountered errors while disposing of store");return Array.isArray(n)?[]:n}else if(n)return n.dispose(),n}var q=class n{constructor(){this._toDispose=new Set;this._isDisposed=!1;We(this)}static{this.DISABLE_DISPOSED_WARNING=!1}dispose(){this._isDisposed||(qe(this),this._isDisposed=!0,this.clear())}get isDisposed(){return this._isDisposed}clear(){if(this._toDispose.size!==0)try{Et(this._toDispose)}finally{this._toDispose.clear()}}add(e){if(!e)return e;if(e===this)throw new Error("Cannot register a disposable on itself!");return de(e,this),this._isDisposed?n.DISABLE_DISPOSED_WARNING||console.warn(new Error("Trying to add a disposable to a DisposableStore that has already been disposed of. The added object will be leaked!").stack):this._toDispose.add(e),e}delete(e){if(e){if(e===this)throw new Error("Cannot dispose a disposable on itself!");this._toDispose.delete(e),e.dispose()}}deleteAndLeak(e){e&&this._toDispose.has(e)&&(this._toDispose.delete(e),de(e,null))}},G=class{constructor(){this._store=new q;We(this),de(this._store,this)}static{this.None=Object.freeze({dispose(){}})}dispose(){qe(this),this._store.dispose()}_register(e){if(e===this)throw new Error("Cannot register a disposable on itself!");return this._store.add(e)}};var X=typeof Buffer<"u",Rt=new z(()=>new Uint8Array(256)),ce,fe,B=class n{static alloc(e){return X?new n(Buffer.allocUnsafe(e)):new n(new Uint8Array(e))}static wrap(e){return X&&!Buffer.isBuffer(e)&&(e=Buffer.from(e.buffer,e.byteOffset,e.byteLength)),new n(e)}static fromString(e,t){return!(t?.dontUseNodeBuffer||!1)&&X?new n(Buffer.from(e)):(ce||(ce=new TextEncoder),new n(ce.encode(e)))}static fromByteArray(e){let t=n.alloc(e.length);for(let r=0,i=e.length;r<i;r++)t.buffer[r]=e[r];return t}static concat(e,t){if(typeof t>"u"){t=0;for(let s=0,o=e.length;s<o;s++)t+=e[s].byteLength}let r=n.alloc(t),i=0;for(let s=0,o=e.length;s<o;s++){let l=e[s];r.set(l,i),i+=l.byteLength}return r}constructor(e){this.buffer=e,this.byteLength=this.buffer.byteLength}clone(){let e=n.alloc(this.byteLength);return e.set(this),e}toString(){return X?this.buffer.toString():(fe||(fe=new TextDecoder),fe.decode(this.buffer))}slice(e,t){return new n(this.buffer.subarray(e,t))}set(e,t){if(e instanceof n)this.buffer.set(e.buffer,t);else if(e instanceof Uint8Array)this.buffer.set(e,t);else if(e instanceof ArrayBuffer)this.buffer.set(new Uint8Array(e),t);else if(ArrayBuffer.isView(e))this.buffer.set(new Uint8Array(e.buffer,e.byteOffset,e.byteLength),t);else throw new Error("Unknown argument 'array'")}readUInt32BE(e){return Mt(this.buffer,e)}writeUInt32BE(e,t){At(this.buffer,e,t)}readUInt32LE(e){return Vt(this.buffer,e)}writeUInt32LE(e,t){Bt(this.buffer,e,t)}readUInt8(e){return Lt(this.buffer,e)}writeUInt8(e,t){Kt(this.buffer,e,t)}indexOf(e,t=0){return Dt(this.buffer,e instanceof n?e.buffer:e,t)}equals(e){return this===e?!0:this.byteLength!==e.byteLength?!1:this.buffer.every((t,r)=>t===e.buffer[r])}};function Dt(n,e,t=0){let r=e.byteLength,i=n.byteLength;if(r===0)return 0;if(r===1)return n.indexOf(e[0]);if(r>i-t)return-1;let s=Rt.value;s.fill(e.length);for(let d=0;d<e.length;d++)s[e[d]]=e.length-d-1;let o=t+e.length-1,l=o,a=-1;for(;o<i;)if(n[o]===e[l]){if(l===0){a=o;break}o--,l--}else o+=Math.max(e.length-l,s[n[o]]),l=e.length-1;return a}function Mt(n,e){return n[e]*2**24+n[e+1]*2**16+n[e+2]*2**8+n[e+3]}function At(n,e,t){n[t+3]=e,e=e>>>8,n[t+2]=e,e=e>>>8,n[t+1]=e,e=e>>>8,n[t]=e}function Vt(n,e){return n[e+0]<<0>>>0|n[e+1]<<8>>>0|n[e+2]<<16>>>0|n[e+3]<<24>>>0}function Bt(n,e,t){n[t+0]=e&255,e=e>>>8,n[t+1]=e&255,e=e>>>8,n[t+2]=e&255,e=e>>>8,n[t+3]=e&255}function Lt(n,e){return n[e]}function Kt(n,e,t){n[t]=e}function Ge(n,e){let t=0,r=0,i;do i=n.readUInt8(e+r),t|=(i&127)<<r*7,r++;while(i&128);return{value:t,consumed:r}}var Xe=n=>{let e=(0,He.readFileSync)(n),t=new Map;for(let r=0;r<e.length;){let i=Ge(B.wrap(e),r);r+=i.consumed,t.set(e.subarray(r,r+i.value),t.size),r+=i.value}return t};var J=class n{constructor(){this._values=[];this._stats={encodeDuration:new S,textLength:new S,callCount:0}}static get instance(){return this._instance||(this._instance=new n),this._instance}init(e,t,r){let i=this._values.length,s=r?Xe:o=>o;return this._values.push((0,M.createTokenizer)(s(e),(0,M.getSpecialTokensByEncoder)(t),(0,M.getRegexByEncoder)(t),64e3)),i}encode(e,t,r){let i=C.create(!0),s=this._values[e].encode(t,r);return this._stats.callCount+=1,this._stats.encodeDuration.update(i.elapsed()),this._stats.textLength.update(t.length),s}destroy(e){this._values[e]=void 0}resetStats(){let e=this._stats,t={callCount:e.callCount,encodeDuration:e.encodeDuration.value,textLength:e.textLength.value};return this._stats.encodeDuration=new S,this._stats.textLength=new S,this._stats.callCount=0,t}};function Pt(){let n=Je.parentPort;if(!n)throw new Error("This module should only be used in a worker thread.");n.on("message",async e=>{try{let t=await J.instance[e.fn](...e.args);n.postMessage({id:e.id,res:t})}catch(t){n.postMessage({id:e.id,err:t})}})}Pt();
//!!! DO NOT modify, this file was COPIED from 'microsoft/vscode'
