'use babel';
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
import React from 'preact-compat';
import moment from 'moment';
import TooltipContainer from './TooltipContainer';
import BlameTooltip from './BlameTooltip';
import * as GitData from '../data/GitData';
import * as IntegrationData from '../data/IntegrationData';
import * as ConfigManager from '../ConfigManager';
class GutterItem extends React.Component {
    constructor(...props) {
        super(...props);
        this.state = {
            commit: {},
            pullRequests: [],
            issues: [],
            metadata: {},
        };
    }
    componentWillMount() {
        this.setState({ commit: this.props.commit });
        if (this.props.commit.commitHash.substr(0, 6) !== '000000') {
            this.fetchCommitData();
            GitData.getRepoMetadata(this.props.commit.repoPath)
                .then((metadata) => {
                this.setState(Object.assign({}, this.state, { metadata }));
            });
        }
    }
    componentDidMount() {
        if (this.props.commit.commitHash.substr(0, 6) !== '000000') {
            IntegrationData
                .getPullRequestsForCommit(`${this.state.commit.repoPath}`, this.state.commit.commitHash)
                .then((pullRequests) => {
                this.setState(Object.assign({}, this.state, { pullRequests: pullRequests }));
                pullRequests.map(this.getIssuesForPullRequest.bind(this));
                // Refresh the commit data
                this.fetchCommitData();
            });
        }
    }
    fetchCommitData() {
        if (this.props.commit.commitHash.substr(0, 6) !== '000000') {
            GitData.getCommit(this.props.commit.repoPath, this.props.commit.commitHash)
                .then((commit) => {
                this.setState(Object.assign({}, this.state, { commit: Object.assign({}, this.state.commit, commit) }));
            });
        }
    }
    getIssuesForPullRequest(pullRequest) {
        return __awaiter(this, void 0, void 0, function* () {
            if (pullRequest) {
                const issues = yield Promise.all(pullRequest.relatedIssueKeys.map(issueKey => IntegrationData.getIssue(this.state.commit.repoPath, issueKey)));
                this.setState(Object.assign({}, this.state, { issues }));
            }
            else {
                this.setState(Object.assign({}, this.state, { issues: [] }));
            }
        });
    }
    tooltip() {
        return (React.createElement(BlameTooltip, { emitter: this.props.emitter, commit: this.state.commit, commitDay: this.props.commitDay, firstCommitDate: this.props.firstCommitDate, pullRequests: this.state.pullRequests, issues: this.state.issues, metadata: this.state.metadata }));
    }
    formattedText() {
        const commit = this.props.commit;
        const date = commit.commitedAt;
        const formattedDate = moment(date).format(ConfigManager.get('gutterDateFormat'));
        let author = commit.author;
        if (ConfigManager.get('truncateGutterNames')) {
            const splitAuthor = author.split(' ');
            if (splitAuthor.length > 1) {
                const lastName = splitAuthor.pop();
                const initials = splitAuthor.map((part) => {
                    return part[0].toUpperCase();
                }).join(' ');
                author = `${initials}. ${lastName}`;
            }
        }
        return `${formattedDate} ${author}`;
    }
    render() {
        if (this.state.commit.commitHash.substr(0, 6) === '000000') {
            return (React.createElement("div", { className: "gutter-text" }, this.formattedText()));
        }
        return (React.createElement("div", null,
            React.createElement(TooltipContainer, { className: "gutter-text", tooltipContent: this.tooltip.bind(this) }, this.formattedText()),
            React.createElement(TooltipContainer, { style: { background: this.props.inidcatorColor }, className: "gutter-age" })));
    }
}
export default GutterItem;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiR3V0dGVySXRlbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9jb21wb25lbnRzL0d1dHRlckl0ZW0udHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFdBQVcsQ0FBQzs7Ozs7Ozs7O0FBRVosT0FBTyxLQUFLLE1BQU0sZUFBZSxDQUFDO0FBQ2xDLE9BQU8sTUFBTSxNQUFNLFFBQVEsQ0FBQztBQUM1QixPQUFPLGdCQUFnQixNQUFNLG9CQUFvQixDQUFDO0FBRWxELE9BQU8sWUFBWSxNQUFNLGdCQUFnQixDQUFDO0FBQzFDLE9BQU8sS0FBSyxPQUFPLE1BQU0saUJBQWlCLENBQUM7QUFDM0MsT0FBTyxLQUFLLGVBQWUsTUFBTSx5QkFBeUIsQ0FBQztBQUMzRCxPQUFPLEtBQUssYUFBYSxNQUFNLGtCQUFrQixDQUFDO0FBa0JsRCxnQkFBaUIsU0FBUSxLQUFLLENBQUMsU0FBZ0M7SUFFN0QsWUFBWSxHQUFHLEtBQUs7UUFDbEIsS0FBSyxDQUFDLEdBQUcsS0FBSyxDQUFDLENBQUM7UUFDaEIsSUFBSSxDQUFDLEtBQUssR0FBRztZQUNYLE1BQU0sRUFBRSxFQUFFO1lBQ1YsWUFBWSxFQUFFLEVBQUU7WUFDaEIsTUFBTSxFQUFFLEVBQUU7WUFDVixRQUFRLEVBQUUsRUFBRTtTQUNiLENBQUE7SUFDSCxDQUFDO0lBRUQsa0JBQWtCO1FBQ2hCLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUMsQ0FBQyxDQUFDO1FBQzNDLEVBQUUsQ0FBQSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFDLENBQUMsQ0FBQyxLQUFLLFFBQVEsQ0FBQyxDQUFBLENBQUM7WUFDeEQsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1lBQ3ZCLE9BQU8sQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFN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LFFBQVEsQ0FBQyxDQUFBLENBQUM7WUFDeEQsTUFBTSxDQUFDLENBQ0wsNkJBQUssU0FBUyxFQUFDLGFBQWEsSUFDekIsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUNqQixDQUNQLENBQUM7UUFDSixDQUFDO1FBQ0QsTUFBTSxDQUFDLENBQ0w7WUFDRSxvQkFBQyxnQkFBZ0IsSUFDZixTQUFTLEVBQUMsYUFBYSxFQUN2QixjQUFjLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBRXRDLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FDSjtZQUNuQixvQkFBQyxnQkFBZ0IsSUFDZixLQUFLLEVBQUUsRUFBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxjQUFjLEVBQUMsRUFDOUMsU0FBUyxFQUFDLFlBQVksR0FDdEIsQ0FDRSxDQUNQLENBQUM7SUFDSixDQUFDO0NBRUY7QUFFRCxlQUFlLFVBQVUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIid1c2UgYmFiZWwnO1xuXG5pbXBvcnQgUmVhY3QgZnJvbSAncHJlYWN0LWNvbXBhdCc7XG5pbXBvcnQgbW9tZW50IGZyb20gJ21vbWVudCc7XG5pbXBvcnQgVG9vbHRpcENvbnRhaW5lciBmcm9tICcuL1Rvb2x0aXBDb250YWluZXInO1xuaW1wb3J0IEJ1aWxkU3RhdHVzIGZyb20gJy4vQnVpbGRTdGF0dXMnO1xuaW1wb3J0IEJsYW1lVG9vbHRpcCBmcm9tICcuL0JsYW1lVG9vbHRpcCc7XG5pbXBvcnQgKiBhcyBHaXREYXRhIGZyb20gJy4uL2RhdGEvR2l0RGF0YSc7XG5pbXBvcnQgKiBhcyBJbnRlZ3JhdGlvbkRhdGEgZnJvbSAnLi4vZGF0YS9JbnRlZ3JhdGlvbkRhdGEnO1xuaW1wb3J0ICogYXMgQ29uZmlnTWFuYWdlciBmcm9tICcuLi9Db25maWdNYW5hZ2VyJztcbmltcG9ydCAqIGFzIEFuYWx5dGljcyBmcm9tICcuLi9zdGVwc2l6ZS9BbmFseXRpY3MnO1xuaW1wb3J0ICogYXMgSW50ZWdyYXRpb25Ob3RpZmljYXRpb24gZnJvbSAnLi4vaW50ZXJmYWNlL0ludGVncmF0aW9uTm90aWZpY2F0aW9uJztcblxuaW50ZXJmYWNlIElHdXR0ZXJJdGVtUHJvcHMge1xuICBjb21taXQ6IGFueTtcbiAgZW1pdHRlcjogYW55O1xuICBpbmlkY2F0b3JDb2xvcjogc3RyaW5nO1xuICBmaXJzdENvbW1pdERhdGU6IERhdGU7XG4gIGNvbW1pdERheTogbnVtYmVyO1xufVxuXG5pbnRlcmZhY2UgSUd1dHRlckl0ZW1TdGF0ZSB7XG4gIGNvbW1pdDogYW55O1xuICBwdWxsUmVxdWVzdHM6IGFueTtcbiAgaXNzdWVzOiBBcnJheTxhbnk+O1xufVxuXG5jbGFzcyBHdXR0ZXJJdGVtIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PElHdXR0ZXJJdGVtUHJvcHMsIGFueT4ge1xuXG4gIGNvbnN0cnVjdG9yKC4uLnByb3BzKXtcbiAgICBzdXBlciguLi5wcm9wcyk7XG4gICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgIGNvbW1pdDoge30sXG4gICAgICBwdWxsUmVxdWVzdHM6IFtdLFxuICAgICAgaXNzdWVzOiBbXSxcbiAgICAgIG1ldGFkYXRhOiB7fSxcbiAgICB9XG4gIH1cblxuICBjb21wb25lbnRXaWxsTW91bnQoKXtcbiAgICB0aGlzLnNldFN0YXRlKHtjb21taXQ6IHRoaXMucHJvcHMuY29tbWl0fSk7XG4gICAgaWYodGhpcy5wcm9wcy5jb21taXQuY29tbWl0SGFzaC5zdWJzdHIoMCw2KSAhPT0gJzAwMDAwMCcpe1xuICAgICAgdGhpcy5mZXRjaENvbW1pdERhdGEoKTtcbiAgICAgIEdpdERhdGEuZ2V0UmVwb01ldGFkYXRhKHRoaXMucHJvcHMuY29tbWl0LnJlcG9QYXRoKVxuICAgICAgICAudGhlbigobWV0YWRhdGEpID0+IHtcbiAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIC4uLnRoaXMuc3RhdGUsXG4gICAgICAgICAgICBtZXRhZGF0YVxuICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBjb21wb25lbnREaWRNb3VudCgpe1xuICAgIGlmKHRoaXMucHJvcHMuY29tbWl0LmNvbW1pdEhhc2guc3Vic3RyKDAsNikgIT09ICcwMDAwMDAnKSB7XG4gICAgICBJbnRlZ3JhdGlvbkRhdGFcbiAgICAgICAgLmdldFB1bGxSZXF1ZXN0c0ZvckNvbW1pdChcbiAgICAgICAgICBgJHt0aGlzLnN0YXRlLmNvbW1pdC5yZXBvUGF0aH1gLFxuICAgICAgICAgIHRoaXMuc3RhdGUuY29tbWl0LmNvbW1pdEhhc2hcbiAgICAgICAgKVxuICAgICAgICAudGhlbigocHVsbFJlcXVlc3RzKSA9PiB7XG4gICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAuLi50aGlzLnN0YXRlLFxuICAgICAgICAgICAgcHVsbFJlcXVlc3RzOiBwdWxsUmVxdWVzdHNcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBwdWxsUmVxdWVzdHMubWFwKHRoaXMuZ2V0SXNzdWVzRm9yUHVsbFJlcXVlc3QuYmluZCh0aGlzKSk7XG4gICAgICAgICAgLy8gUmVmcmVzaCB0aGUgY29tbWl0IGRhdGFcbiAgICAgICAgICB0aGlzLmZldGNoQ29tbWl0RGF0YSgpO1xuICAgICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBmZXRjaENvbW1pdERhdGEoKXtcbiAgICBpZih0aGlzLnByb3BzLmNvbW1pdC5jb21taXRIYXNoLnN1YnN0cigwLDYpICE9PSAnMDAwMDAwJyl7XG4gICAgICBHaXREYXRhLmdldENvbW1pdCh0aGlzLnByb3BzLmNvbW1pdC5yZXBvUGF0aCwgdGhpcy5wcm9wcy5jb21taXQuY29tbWl0SGFzaClcbiAgICAgICAgLnRoZW4oKGNvbW1pdCkgPT4ge1xuICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgLi4udGhpcy5zdGF0ZSxcbiAgICAgICAgICAgIGNvbW1pdCA6IHtcbiAgICAgICAgICAgICAgLi4udGhpcy5zdGF0ZS5jb21taXQsXG4gICAgICAgICAgICAgIC4uLmNvbW1pdFxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBnZXRJc3N1ZXNGb3JQdWxsUmVxdWVzdChwdWxsUmVxdWVzdCkge1xuICAgIGlmIChwdWxsUmVxdWVzdCkge1xuICAgICAgY29uc3QgaXNzdWVzID0gYXdhaXQgUHJvbWlzZS5hbGwocHVsbFJlcXVlc3QucmVsYXRlZElzc3VlS2V5cy5tYXAoXG4gICAgICAgIGlzc3VlS2V5ID0+IEludGVncmF0aW9uRGF0YS5nZXRJc3N1ZSh0aGlzLnN0YXRlLmNvbW1pdC5yZXBvUGF0aCwgaXNzdWVLZXkpXG4gICAgICApKTtcbiAgICAgIHRoaXMuc2V0U3RhdGUoeyAuLi50aGlzLnN0YXRlLCBpc3N1ZXMgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuc2V0U3RhdGUoeyAuLi50aGlzLnN0YXRlLCBpc3N1ZXM6IFtdIH0pXG4gICAgfVxuICB9XG5cbiAgdG9vbHRpcCgpe1xuICAgIHJldHVybiAoXG4gICAgICA8QmxhbWVUb29sdGlwXG4gICAgICAgIGVtaXR0ZXI9e3RoaXMucHJvcHMuZW1pdHRlcn1cbiAgICAgICAgY29tbWl0PXt0aGlzLnN0YXRlLmNvbW1pdH1cbiAgICAgICAgY29tbWl0RGF5PXt0aGlzLnByb3BzLmNvbW1pdERheX1cbiAgICAgICAgZmlyc3RDb21taXREYXRlPXt0aGlzLnByb3BzLmZpcnN0Q29tbWl0RGF0ZX1cbiAgICAgICAgcHVsbFJlcXVlc3RzPXt0aGlzLnN0YXRlLnB1bGxSZXF1ZXN0c31cbiAgICAgICAgaXNzdWVzPXt0aGlzLnN0YXRlLmlzc3Vlc31cbiAgICAgICAgbWV0YWRhdGE9e3RoaXMuc3RhdGUubWV0YWRhdGF9XG4gICAgICAvPlxuICAgIClcbiAgfVxuXG4gIGZvcm1hdHRlZFRleHQoKSB7XG4gICAgY29uc3QgY29tbWl0ID0gdGhpcy5wcm9wcy5jb21taXQ7XG4gICAgY29uc3QgZGF0ZSA9IGNvbW1pdC5jb21taXRlZEF0O1xuICAgIGNvbnN0IGZvcm1hdHRlZERhdGUgPSBtb21lbnQoZGF0ZSkuZm9ybWF0KENvbmZpZ01hbmFnZXIuZ2V0KCdndXR0ZXJEYXRlRm9ybWF0JykpO1xuICAgIGxldCBhdXRob3IgPSBjb21taXQuYXV0aG9yO1xuICAgIGlmKENvbmZpZ01hbmFnZXIuZ2V0KCd0cnVuY2F0ZUd1dHRlck5hbWVzJykpe1xuICAgICAgY29uc3Qgc3BsaXRBdXRob3IgPSBhdXRob3Iuc3BsaXQoJyAnKTtcbiAgICAgIGlmKHNwbGl0QXV0aG9yLmxlbmd0aCA+IDEpe1xuICAgICAgICBjb25zdCBsYXN0TmFtZSA9IHNwbGl0QXV0aG9yLnBvcCgpO1xuICAgICAgICBjb25zdCBpbml0aWFscyA9IHNwbGl0QXV0aG9yLm1hcCgocGFydCkgPT4ge1xuICAgICAgICAgIHJldHVybiBwYXJ0WzBdLnRvVXBwZXJDYXNlKClcbiAgICAgICAgfSkuam9pbignICcpO1xuICAgICAgICBhdXRob3IgPSBgJHtpbml0aWFsc30uICR7bGFzdE5hbWV9YDtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGAke2Zvcm1hdHRlZERhdGV9ICR7YXV0aG9yfWBcbiAgfVxuXG4gIHJlbmRlcigpIHtcbiAgICBpZih0aGlzLnN0YXRlLmNvbW1pdC5jb21taXRIYXNoLnN1YnN0cigwLDYpID09PSAnMDAwMDAwJyl7XG4gICAgICByZXR1cm4gKFxuICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cImd1dHRlci10ZXh0XCI+XG4gICAgICAgICAge3RoaXMuZm9ybWF0dGVkVGV4dCgpfVxuICAgICAgICA8L2Rpdj5cbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiAoXG4gICAgICA8ZGl2PlxuICAgICAgICA8VG9vbHRpcENvbnRhaW5lclxuICAgICAgICAgIGNsYXNzTmFtZT1cImd1dHRlci10ZXh0XCJcbiAgICAgICAgICB0b29sdGlwQ29udGVudD17dGhpcy50b29sdGlwLmJpbmQodGhpcyl9XG4gICAgICAgID5cbiAgICAgICAgICB7dGhpcy5mb3JtYXR0ZWRUZXh0KCl9XG4gICAgICAgIDwvVG9vbHRpcENvbnRhaW5lcj5cbiAgICAgICAgPFRvb2x0aXBDb250YWluZXJcbiAgICAgICAgICBzdHlsZT17e2JhY2tncm91bmQ6IHRoaXMucHJvcHMuaW5pZGNhdG9yQ29sb3J9fVxuICAgICAgICAgIGNsYXNzTmFtZT1cImd1dHRlci1hZ2VcIlxuICAgICAgICAvPlxuICAgICAgPC9kaXY+XG4gICAgKTtcbiAgfVxuXG59XG5cbmV4cG9ydCBkZWZhdWx0IEd1dHRlckl0ZW07XG4iXX0=