import { Component } from 'react'
import App, { Container } from 'next/app'
import { JssProvider } from 'react-jss'

import Root from '../components/Root'
import { getSheetsRegistry } from '../services/SheetsRegistry'
import Ships from '../contexts/Ships'

export default class MyApp extends App {
	static async getInitialProps({ Component: Page, ctx }) {
		let fetch

		if (typeof window !== 'undefined') {
			fetch = window.fetch
		} else {
			/* eslint-ignore-next-line */
			fetch = await import('node-fetch').then(m => m.default)
		}

		const shipsPromise = fetch('http://demo7475333.mockable.io/spaceships')
			.then(res => res.json())
			.then(data => data.products)
			.then(ships => normalizeShips(ships))

		const pageInitialPropsPromise = Page.getInitialProps
			? Page.getInitialProps(ctx)
			: Promise.resolve({})

		const [ships, pageProps] = await Promise.all([
			shipsPromise,
			pageInitialPropsPromise,
		])

		return { ships, pageProps }
	}

	render() {
		// these props are given to us by Next.js. See Next.js docs: https://nextjs.org/docs#custom-%3Capp%3E
		const { Component: PageComponent, pageProps } = this.props

		return (
			/*
				JssProvider for ServerSide rendering, see:
				http://cssinjs.org/react-jss?v=v8.6.1#server-side-rendering
				and
				https://github.com/cssinjs/jss/issues/457#issuecomment-418877493
				Also look at _document.tsx
	       */
			<JssProvider registry={getSheetsRegistry()}>
				<Ships.Provider value={this.props.ships}>
					<Container>
						<Root PageComponent={PageComponent} pageProps={pageProps} />
					</Container>
				</Ships.Provider>
			</JssProvider>
		)
	}
}

// descriptions are from Wookieepedia (http://starwars.wikia.com/wiki)
const ourInfo = {
	'Twin Ion Engine Starfighter': {
		sketchFabId: 'c306f5183f364176912d782b19474781',
		description:
			'The TIE/LN starfighter, or TIE/line starfighter, simply known as the TIE Fighter or T/F, was the standard Imperial starfighter seen in massive numbers throughout most of the Galactic Civil War and onward. Colloquially, Rebel and New Republic pilots referred to the craft as "eyeballs."',
	},
	'T-65 X-wing Starfighter': {
		sketchFabId: '6fdd3b18c4b245bf9eba1fd32611496a',
		description:
			'The Incom T-65 X-wing starfighter was the primary all-purpose starfighter of the Rebel Alliance and its successor governments. Known for its versatility and exceptional combat performance, it was a favorite with Rebel and New Republic pilots. Possessing deflector shields, a hyperdrive, an R2 astromech for repairs and navigation, and a complement of proton torpedoes, the X-wing allowed the Rebellion to launch raids in Imperial space with improved odds of a successful mission.',
	},
	'Y-wing Starfighter': {
		sketchFabId: '81ff7bf0ac9b42558539903a371ab74b',
		description:
			'The BTL Y-wing starfighter was a fighter-bomber built by Koensayr Manufacturing. First used during the Clone Wars, then throughout the Galactic Civil War, it was a mainstay of the Alliance Starfighter Corps. It was often used as an assault bomber to attack enemy capital ships directly in conjunction with the later B-wing starfighters.',
	},
	'YT-1300 Light Freighter': {
		sketchFabId: 'd5c87a25edcc4fd19ea638179fd6eb48',
		description:
			'The YT-1300 light freighter, also known as the YT-1300 Corellian freighter, was a type of light freighter manufactured by the Corellian Engineering Corporation that saw operation in the galaxy during the final days of the Galactic Republic and the reign of the Galactic Empire. By the year 0 BBY, it was considered an outdated model. The Millennium Falcon, a smuggling vessel that became part of the Rebel Alliance fleet, was a YT-1300 of the YT-1300f variety.',
	},
	'Alpha-class Xg-1 Star Wing': {
		sketchFabId: false,
		description:
			"The Alpha-class Xg-1 Star Wing was a starship model utilized by the Alliance to Restore the Republic during the Galactic Civil War. During the Alliance defeat in the skirmish in the Recluse's Nebula, in which the Alliance suffered a net loss of Alliance Fleet assets, one Star Wing was lost among others with a loss of 125,000 credits. The lost Star Wing, along with other lost assets, were listed in an official report filed by General Baccam Grafis of Ordnance and Supply to Commander-in-Chief Mon Mothma.",
	},
	'Lambda-class T-4a shuttle': {
		sketchFabId: '4786e7c069c64f609c3fd51ef36e0390',
		description:
			'The Lambda-class T-4a shuttle, also known as the Imperial Lambda, Imperial Transport or the Imperial Shuttle, was a multi-purpose transport with a trihedral foil design used by the Galactic Empire during the Galactic Civil War, and was considered an elegant departure from the standards of brutish Imperial engineering. The shuttles were often used by high-ranking Imperial officers and such dignitaries as Darth Vader and Emperor Sheev Palpatine, but were more commonly found ferrying stormtroopers or cargo.',
	},
	'RZ-1 A-wing interceptor': {
		sketchFabId: 'b13126de57c44f5388e80b411f47078e',
		description:
			'The RZ-1 A-wing interceptor, also known as the RZ-1 A-wing starfighter, was a wedge-shaped starfighter manufactured by Kuat Systems Engineering, which took design inspiration from the Republic starfighters of the Clone Wars. Based on the original R-22 prototype, the early rebel movement adopted the fighter against the Galactic Empire, letting these so-called RZ-1s see action during the Age of the Empire and the Galactic Civil War.',
	},
	'B-wing heavy assault starfighter': {
		sketchFabId: '1165fd6ec1e243b6a5f5ff28e85a222c',
		description:
			'The A/SF-01 B-wing starfighter, also designated as the A/SF-01 B-wing assault starfighter, more commonly referred to as the B-wing, was a heavily armed Rebel Alliance single-pilot starfighter and bomber manufactured by Slayn & Korpil. The B-wing saw action during the Galactic Civil War and was subsequently substituted by the B-wing Mark II.',
	},
}

function normalizeShips(ships) {
	for (const ship of ships) {
		ship.sketchFabId = ourInfo[ship.name].sketchFabId
		ship.description = ourInfo[ship.name].description
	}

	return ships
}
